# Backend AI Guide - Badminton App

This guide provides instructions for AI assistants working on the Spring Boot Java backend.

## Entity Annotations - ALWAYS Use Jakarta

**IMPORTANT**: Always use `jakarta.persistence.*` annotations on all entities. Never use Spring Data annotations (`org.springframework.data.annotation.*` or `org.springframework.data.relational.core.mapping.*`) on entities.

### ✅ Correct - Jakarta annotations
```java
import jakarta.persistence.*;

@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
}
```

### ❌ Wrong - Spring Data annotations
```java
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Table;

@Table("users")
public class User {
    @Id
    private Long id;
}
```

### Entity Relationship Mapping
Use proper Jakarta relationship annotations:
```java
// OneToMany on parent entity
@OneToMany(mappedBy = "tournament", cascade = CascadeType.ALL, orphanRemoval = true)
private List<TournamentAdmin> admins = new ArrayList<>();

// ManyToOne on child entity
@ManyToOne
@JoinColumn(name = "tournament_id", referencedColumnName = "id")
private Tournament tournament;
```

- Never use `@MappedCollection` (Spring Data JDBC specific)
- Never use `org.springframework.data.annotation.Id`
- Never use `org.springframework.data.relational.core.mapping.Table`
- Never add redundant FK `Long` fields (e.g. `tournamentId`) when a `@ManyToOne` object reference exists
- Always use `jakarta.persistence.*` wildcard import for entities
- Always add `@GeneratedValue(strategy = GenerationType.IDENTITY)` on `@Id` fields
- Always use `JpaRepository<T, ID>` in repositories, not `CrudRepository`
- This project uses **Spring Data JPA** (`spring-boot-starter-data-jpa`), NOT Spring Data JDBC
- Do NOT create documentation .md files unless explicitly requested

## Windows PowerShell Command Syntax

**IMPORTANT**: This project runs on Windows PowerShell, not bash. Use these syntax rules:

- **Command chaining**: Use `;` (semicolon) instead of `&&` (ampersand-ampersand)
  - ❌ Wrong: `cd backend && mvn clean install && mvn spring-boot:run`
  - ✅ Correct: `cd backend; mvn clean install; mvn spring-boot:run`

- **Piping**: Use `|` as normal, but be aware of PowerShell-specific tools
  - ❌ Wrong: Use `tail -20` or `head -10` (these are Unix commands)
  - ✅ Correct: Use PowerShell equivalents like `Select-Object -Last 20`

## Backend Project Structure

```
backend/
├── src/
│   ├── main/
│   │   ├── java/nl/amila/badminton/manager/
│   │   │   └── Application.java        # Main Spring Boot application class
│   │   └── resources/
│   │       ├── application.yaml        # Spring Boot configuration
│   │       ├── static/                 # Static assets served by backend
│   │       └── templates/              # HTML templates (if used)
│   └── test/
│       └── java/nl/amila/badminton/manager/
│           ├── ApplicationTests.java   # Main application tests
│           ├── TestApplication.java    # Test application class
│           └── TestcontainersConfiguration.java
├── pom.xml                             # Maven configuration
├── target/                             # Build output directory
└── mvnw / mvnw.cmd                     # Maven Wrapper (Windows)
```

## Setup and Installation

### First Time Setup
```powershell
cd E:\learn\badminton-app\backend
mvn clean install
```

This:
1. Cleans previous builds
2. Resolves all Maven dependencies
3. Compiles Java source code
4. Runs unit tests
5. Packages application

### Check Java and Maven Versions
```powershell
java -version
mvn --version
```

Recommended:
- Java 21
- Maven 3.6.0 or higher

## Running Commands

### Build the Application
```powershell
cd E:\learn\badminton-app\backend
mvn clean install
```
- Full build with tests
- Creates JAR file in `target/` directory

### Build Without Tests
```powershell
cd E:\learn\badminton-app\backend
mvn clean install -DskipTests
```
- Faster build, skips test execution
- Use only when you're confident in changes

### Run the Application
```powershell
cd E:\learn\badminton-app\backend
mvn spring-boot:run
```
- Starts the Spring Boot application
- Default port: 8098 (see `application.yaml`)
- Serves frontend from `target/dist/` if frontend is built
- Press Ctrl+C to stop

### Run Tests
```powershell
cd E:\learn\badminton-app\backend
mvn test
```
- Runs only unit and integration tests
- Useful for validation before builds

### Clean Build Artifacts
```powershell
cd E:\learn\badminton-app\backend
mvn clean
```
- Removes `target/` directory
- Good before committing or when troubleshooting

## Critical Files

### pom.xml
Maven project configuration. Contains:
- Project metadata
- Dependencies and their versions
- Build plugins and configurations
- Properties (like Java version, project encoding)

**Important properties to check**:
- `java.version` - Java version (set to 21 in the backend module)
- `project.build.sourceEncoding` - Character encoding

### application.yaml
Spring Boot configuration:
- Server port (default: 8098)
- Database connection settings
- Logging configuration
- Custom application properties

Key settings:
```yaml
server:
  port: 8098              # Backend runs on this port
  
spring:
  application:
    name: badminton-manager
```

### Application.java
Main Spring Boot entry point. Contains:
```java
@SpringBootApplication
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

Do not modify unless adding startup configuration.

## Validating Backend Changes (Without False Failures)

After editing Java source files, always validate the build compiles cleanly. Follow these rules carefully to avoid false positives.

### ✅ Correct Compile-Check Command (PowerShell)

Use the Maven Wrapper from the **backend** directory, and filter output with PowerShell's `Select-Object`:

```powershell
cd E:\learn\badminton-app\backend
.\..\mvnw.cmd compile 2>&1 | Select-Object -Last 10
```

A successful result ends with:
```
[INFO] BUILD SUCCESS
```

A failed result ends with:
```
[INFO] BUILD FAILURE
```

**Do not use `tail`** — it is a Unix command and does not exist in PowerShell.
```powershell
# ❌ Wrong — will throw CommandNotFoundException
.\..\mvnw.cmd compile 2>&1 | tail -10

# ✅ Correct — PowerShell equivalent
.\..\mvnw.cmd compile 2>&1 | Select-Object -Last 10
```

To filter for specific problems only:
```powershell
.\..\mvnw.cmd compile 2>&1 | Select-String -Pattern "\[ERROR\]" | Select-Object -Last 20
```

### Understanding `get_errors` Tool Output

The IDE's `get_errors` tool reports diagnostics at two severity levels:

| Severity | Meaning | Action required? |
|----------|---------|------------------|
| `ERROR` | Real compile error — code will not build | **Yes — must fix** |
| `WARNING(300)` | IDE hint/inspection — code still compiles | No — informational only |

**Common false-positive warnings** that do NOT indicate a real problem:

- `"Enum 'X' is never used"` — The enum is used from other classes the IDE hasn't indexed yet
- `"Constructor 'X(...)' is never used"` — The constructor is called from other files
- `"Method 'X' is never used"` — The method is called from other classes (e.g. controllers calling service methods)
- `"Selector form-check-input is never used"` — Pre-existing Vue CSS scoping warning, unrelated to the change

**Always confirm with `mvnw.cmd compile`** — if it reports `BUILD SUCCESS`, the code is valid regardless of IDE warnings.

### Lombok-Specific Notes

This project uses Lombok for code generation. IDE errors on Lombok-annotated classes are often false positives:

- `@Getter` / `@Setter` on a class generates getters/setters for all fields
- `@Setter(lombok.AccessLevel.NONE)` on a specific field **suppresses** its setter — this is intentional for immutable fields (e.g. `Tournament.type`)
- IDE may warn about "problems related to" a Lombok class — compile with Maven to confirm it is actually fine

### Immutable Field Pattern

When adding a field that must be set at creation and never modified (e.g. `type` on `Tournament`):

```java
// ✅ Correct pattern for an immutable field
@Setter(lombok.AccessLevel.NONE)   // suppresses setter generation for this field only
@Column(nullable = false, updatable = false)  // enforces immutability at DB level too
private TournamentType type;
```

The field is set via the constructor only. Do not expose a public setter for it.

## Database Migrations

`schema.sql` uses `CREATE TABLE IF NOT EXISTS` — it only creates tables on a **fresh** database. For an **existing** running database, schema changes must be applied manually with `ALTER TABLE`.

### Migration files location

```
backend/src/main/resources/migrations/
```

Migration SQL files are stored here for reference and must be run manually against the live database.

### How to run SQL against the database

**Option A — MySQL CLI**
```powershell
mysql -u root -p badminton < E:\learn\badminton-app\backend\src\main\resources\migrations\alter_tournament_add_type.sql
```

**Option B — MySQL Workbench / DBeaver / DataGrip**

Open the migration file and execute it directly in your SQL client connected to the `badminton` database.

**Option C — Inline in MySQL CLI**
```sql
ALTER TABLE tournament
    ADD COLUMN IF NOT EXISTS type VARCHAR(20) NOT NULL DEFAULT 'ONE_OFF';
```

### General migration pattern for future schema changes

Whenever `schema.sql` is updated with a new column, index, or table:

1. Write a corresponding `ALTER TABLE` (or `CREATE TABLE`) statement
2. Save it to `backend/src/main/resources/migrations/` with a descriptive name, e.g. `alter_users_add_phone.sql`
3. Run it manually against the live database
4. The `schema.sql` change covers fresh installs; the migration file covers existing installs

## Common Issues and Solutions

### Issue: Port 8098 already in use
**Error**: `Port 8098 is already in use`
**Solution**:
1. Find and kill the process using port 8098:
   ```powershell
   Get-NetTCPConnection -LocalPort 8098
   Stop-Process -Id [PID] -Force
   ```
2. Or change port in `application.yaml`:
   ```yaml
   server:
     port: 8099
   ```
3. Update frontend proxy configuration in `frontend/vue.config.js` to match

### Issue: Maven build fails - "BUILD FAILURE"
**Possible causes**:
1. Tests failing - check test output
2. Missing dependencies - check internet connection
3. Java version mismatch - check Java version
4. Corrupted Maven cache - clear cache:
   ```powershell
   Remove-Item $env:USERPROFILE\.m2\repository -Recurse -Force
   mvn clean install
   ```

### Issue: Dependencies won't download
**Solution**:
1. Check internet connection
2. Update Maven:
   ```powershell
   mvn --version
   ```
3. Use local repository mirror if behind corporate proxy
4. Try again - temporary network issues are common

### Issue: Application starts but won't respond to requests
**Check**:
1. Application actually started - look for "Started Application in X.XXX seconds"
2. Correct port in browser/API calls (8098)
3. Check `application.yaml` for configuration errors
4. Check server logs for errors

## Frontend Integration

The backend serves the frontend:
1. Frontend builds to `../frontend/target/dist/`
2. Backend Spring Boot includes this in classpath
3. When backend starts, it serves frontend as static content
4. Browser loads `index.html` from backend
5. Vue Router handles routing on client side
6. API calls to `/api/*` endpoints are handled by backend Java code

**Important**: After building frontend, restart backend to serve latest version.

## Database Setup (if applicable)

Check `application.yaml` for database configuration:
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/badminton
    username: root
    password: password
  jpa:
    hibernate:
      ddl-auto: update
```

Ensure database is running before starting backend.

## Testing

### Tests Are Mandatory in Every Plan

**IMPORTANT**: Updating or adding tests is a **required step** in every plan that involves backend changes. Never skip this.

When planning any backend task (new feature, bug fix, refactor, or schema change):

1. **Always include an "Update / Add Tests" step** in the plan
2. Write or update unit tests **before or alongside** the implementation (not after)
3. Every new service method, controller endpoint, or entity change **must** have corresponding tests
4. Tests live in `src/test/java/nl/amila/badminton/manager/`
5. Service-layer tests go in `service/` using `@ExtendWith(MockitoExtension.class)` + `@Mock` / `@InjectMocks`
6. After writing tests, always run them to confirm they pass:
   ```powershell
   cd E:\learn\badminton-app\backend
   mvn test
   ```

#### Test Coverage Checklist (per service method)
- ✅ Happy-path (success) test
- ✅ Not-found / empty result test
- ✅ Invalid input / wrong role test
- ✅ Duplicate / already-exists test (where applicable)
- ✅ Access-denied / security test (where applicable)

#### Example Test Structure (TournamentServiceTest pattern)
```java
@ExtendWith(MockitoExtension.class)
class MyServiceTest {

    @Mock
    private MyRepository myRepository;

    @InjectMocks
    private MyService myService;

    @BeforeEach
    void setUp() { /* set up shared fixtures */ }

    @Test
    void testMyMethod_Success() { /* happy path */ }

    @Test
    void testMyMethod_NotFound() { /* not-found branch */ }

    @Test
    void testMyMethod_InvalidInput() { /* validation branch */ }
}
```

### Run All Tests
```powershell
cd E:\learn\badminton-app\backend
mvn test
```

### Run Specific Test
```powershell
cd E:\learn\badminton-app\backend
mvn test -Dtest=ApplicationTests
```

### Run Tests with Maven During Build
Tests run automatically during `mvn clean install`.

## Dependencies Management

Key Spring Boot Starters (from pom.xml):
- `spring-boot-starter-web` - Web application support
- `spring-boot-starter-data-jpa` - Database ORM
- `spring-boot-starter-test` - Testing framework

Lombok is used to reduce boilerplate in DTOs and entities. Ensure annotation processing is enabled in your IDE.

When adding dependencies:
1. Update pom.xml with new dependency
2. Run `mvn clean install`
3. Test application: `mvn spring-boot:run`
4. Run tests: `mvn test`

## Debugging

### Enable Debug Logging
In `application.yaml`:
```yaml
logging:
  level:
    root: INFO
    nl.amila.badminton: DEBUG
```

### Run in Debug Mode
```powershell
cd E:\learn\badminton-app\backend
mvn spring-boot:run -Dspring-boot.run.jvmArguments="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005"
```

Connect IDE debugger to `localhost:5005`.

## Build Output

After successful build:
- JAR file: `target/badminton-manager-0.0.1-SNAPSHOT.jar` (example name)
- Classes: `target/classes/`
- Test results: `target/surefire-reports/`

## Maven Wrapper

Use `mvnw.cmd` instead of `mvn` command if Maven is not in PATH:
```powershell
cd E:\learn\badminton-app\backend
.\mvnw.cmd clean install
```

This uses the bundled Maven wrapper.

## Performance Considerations

### Build Speed
- Full build: `mvn clean install` (slowest, includes tests)
- Quick build: `mvn clean install -DskipTests` (faster, skips tests)
- Incremental: `mvn install` (fastest, uses existing target)

### Memory Usage
For large projects, increase Maven memory:
```powershell
$env:MAVEN_OPTS = "-Xmx1024m"
mvn clean install
```

## Troubleshooting Commands

```powershell
# Show Maven version and active profile
mvn --version

# Show dependency tree
mvn dependency:tree

# Find dependency conflicts
mvn dependency:tree -Dverbose

# Check for outdated plugins
mvn versions:display-plugin-updates

# Check for outdated dependencies
mvn versions:display-dependency-updates
```

## Deployment

### Create Executable JAR
```powershell
cd E:\learn\badminton-app\backend
mvn clean install
```

JAR file location: `target/badminton-manager-*.jar`

### Run JAR File
```powershell
java -jar target/badminton-manager-*.jar
```

### Docker Deployment
See root `Dockerfile` for containerization instructions.

## Getting Help

When asking for help:
1. Always provide the error message and stack trace
2. Run `mvn clean install` to reproduce if possible
3. Share relevant parts of `pom.xml`
4. Mention Java version: `java -version`
5. Mention Maven version: `mvn --version`
6. Reference the root `.ai-guide.md` for general project structure
7. Check `application.yaml` for configuration issues

## Root Project Configuration

The root `pom.xml` contains parent configuration for both frontend and backend:
- Maven plugins
- Shared properties
- Build profiles

Check root pom.xml if build issues affect entire project.

